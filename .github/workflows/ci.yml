name: Playwright CI

on:
  pull_request:
  workflow_dispatch:
    inputs:
      client:
        description: "Client (configs/<client>.json)"
        type: string
        required: true
        default: "LondonDrugs"
      # Choose which projects to run (booleans)
      run_api:
        description: "Run API project"
        type: boolean
        required: true
        default: true
      run_chromium:
        description: "Run Chromium UI"
        type: boolean
        required: true
        default: true
      run_firefox:
        description: "Run Firefox UI"
        type: boolean
        required: true
        default: true
      run_webkit:
        description: "Run WebKit UI"
        type: boolean
        required: true
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CLIENT: ${{ github.event.inputs.client || 'LondonDrugs' }}
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      REPORT_TO: ${{ secrets.REPORT_TO }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: '20' }

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # Build the --project flags from the manual inputs (or defaults on PR)
      - name: Build project selection
        id: select
        shell: bash
        run: |
          set -euo pipefail
          PROJS=()
          # On workflow_dispatch these are 'true'/'false' strings; on PR they may be empty -> default true
          [[ "${{ github.event.inputs.run_api || 'true' }}" == 'true' ]] && PROJS+=("api")
          [[ "${{ github.event.inputs.run_chromium || 'true' }}" == 'true' ]] && PROJS+=("chromium")
          [[ "${{ github.event.inputs.run_firefox  || 'true' }}" == 'true' ]] && PROJS+=("firefox")
          [[ "${{ github.event.inputs.run_webkit   || 'true' }}" == 'true' ]] && PROJS+=("webkit")

          if [[ ${#PROJS[@]} -eq 0 ]]; then
            echo "No projects selected â€” nothing to run."
            echo "args=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ARGS=""
          for p in "${PROJS[@]}"; do ARGS="$ARGS --project=$p"; done
          echo "Selected projects: ${PROJS[*]}"
          echo "args=$ARGS" >> "$GITHUB_OUTPUT"

      - name: Run Playwright (single process, selected projects)
        if: steps.select.outputs.args != ''
        run: |
          CLIENT="${{ env.CLIENT }}" \
          npx playwright test \
            ${{ steps.select.outputs.args }} \
            --reporter=list,allure-playwright,./utils/reporter-plugin.js

      - name: Generate Allure HTML
        if: always()
        run: npx allure generate allure-results --clean -o allure-report

      - name: Upload Allure artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ env.CLIENT }}
          path: allure-report
